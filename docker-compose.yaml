version: "3.6"

services:
  tmsftt-db:
    image: mysql
    command: --default-authentication-plugin=mysql_native_password --character-set-server=utf8mb4 --collation-server=utf8mb4_unicode_ci
    environment:
      - MYSQL_USER=root
      - MYSQL_ROOT_PASSWORD_FILE=/run/secrets/mysql-root-password
      - MYSQL_DATABASE=TMSFTT
    volumes:
      - "./data/db-data:/var/lib/mysql"
    ports:
      - "8078:3306"
    secrets:
      - mysql-root-password
  tmsftt-apis:
    image: rest-apis:latest
    command: ["./wait-for-it.sh", "tmsftt-db:3306", "-s", "-t", "120", "--", "uwsgi", "--ini", "/uwsgi.ini"]
    environment:
      - SECRET_KEY_FILE=/run/secrets/django-secret-key
      - DATABASE_PASSWORD_FILE=/run/secrets/mysql-root-password
      - DJANGO_SETTINGS_MODULE=TMSFTT.settings_prod
    secrets:
      - django-secret-key
      - mysql-root-password
    depends_on:
      - tmsftt-db
    volumes:
      - "./data/media-data:/media"
    deploy:
      mode: global
      restart_policy:
        condition: on-failure
        delay: 3s
  tmsftt-web-server:
    image: web-server:latest
    ports:
      - "8000:80"
    depends_on:
      - tmsftt-apis
    volumes:
      - "./data/media-data:/media:ro"
    deploy:
      replicas: 1
      restart_policy:
        condition: on-failure
        delay: 3s
  visualizer:
    image: dockersamples/visualizer:stable
    ports:
      - "8080:8080"
    volumes:
      - "/var/run/docker.sock:/var/run/docker.sock"
    deploy:
      placement:
        constraints: [node.role == manager]

secrets:
  django-secret-key:
    file: ./secrets/django-secret-key
  mysql-root-password:
    file: ./secrets/mysql-root-password